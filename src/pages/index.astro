---
import { getImage } from 'astro:assets';
import Layout from '@/layouts/Layout.astro';
import Footer from '@/components/shared/Footer.astro';
import ModeToggle from '@/components/shared/ModeToggle.vue';
import Hero from '@/components/developer/Hero.vue';
import ExperienceTimeline from '@/components/developer/ExperienceTimeline.vue';
import SkillsGrid from '@/components/developer/SkillsGrid.vue';
import ProjectCards from '@/components/developer/ProjectCards.vue';
import SectionNav from '@/components/developer/SectionNav.vue';
import MasonryGallery from '@/components/photographer/MasonryGallery.vue';
import ModeTransitionController from '@/components/shared/ModeTransitionController.vue';
import { loadSiteConfig, loadExperience, loadProjects, loadSkills, loadPhotos } from '@/utils/data';

import avatarImage from '@/assets/images/ryou.png';

const site = loadSiteConfig();
const experiences = loadExperience();
const projects = loadProjects();
const skills = loadSkills();
const photosData = loadPhotos();

// Process avatar image for Hero
let optimizedAvatar: Awaited<ReturnType<typeof getImage>>;
try {
  optimizedAvatar = await getImage({ src: avatarImage, width: 160 });
} catch (e) {
  console.error('[index] Failed to optimize avatar image, using raw source:', e);
  optimizedAvatar = { src: avatarImage.src, attributes: { width: 160, height: 160 } } as Awaited<
    ReturnType<typeof getImage>
  >;
}

// Batch-process gallery images via import.meta.glob
const galleryModules = import.meta.glob<{ default: ImageMetadata }>(
  '../assets/images/gallery/*.{jpg,jpeg,png,webp}',
  { eager: true },
);

const galleryResults = await Promise.all(
  photosData.map(async (photo) => {
    const modulePath = `../assets/images/gallery/${photo.src.replace('gallery/', '')}`;
    const mod = galleryModules[modulePath];
    if (!mod) {
      console.warn(
        `[index] Missing gallery image: ${photo.src} (expected at ${modulePath}), skipping`,
      );
      return null;
    }
    try {
      const optimized = await getImage({ src: mod.default, width: 800 });
      return {
        src: optimized.src,
        width: (optimized.attributes.width as number) ?? 800,
        height: (optimized.attributes.height as number) ?? 600,
        alt: photo.alt,
        caption: photo.caption,
        date: photo.date,
        location: photo.location,
        camera: photo.camera,
      };
    } catch (e) {
      console.warn(`[index] Failed to optimize gallery image: ${photo.src}, skipping:`, e);
      return null;
    }
  }),
);
const galleryImages = galleryResults.filter((img) => img !== null);
---

<Layout>
  <!-- Liquid Glass SVG filter (Chromium-only refraction enhancement) -->
  <svg style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true">
    <defs>
      <filter id="liquid-glass-filter" color-interpolation-filters="sRGB">
        <feTurbulence
          type="fractalNoise"
          baseFrequency="0.015"
          numOctaves="2"
          seed="3"
          result="noise"></feTurbulence>
        <feDisplacementMap
          in="SourceGraphic"
          in2="noise"
          scale="6"
          xChannelSelector="R"
          yChannelSelector="G"
          result="displaced"></feDisplacementMap>
        <feGaussianBlur in="displaced" stdDeviation="0.5" result="softened"></feGaussianBlur>
        <feComposite in="softened" in2="SourceGraphic" operator="in"></feComposite>
      </filter>
    </defs>
  </svg>

  <div id="toggle-wrapper" class="fixed top-4 right-4 z-50">
    <ModeToggle client:load />
  </div>

  <ModeTransitionController client:load />

  <main>
    <!-- Developer Mode sections -->
    <div id="developer-content">
      <div id="hero">
        <Hero
          client:load
          name={site.name}
          title={site.title}
          intro={site.intro}
          avatarSrc={optimizedAvatar.src}
          avatarWidth={optimizedAvatar.attributes.width as number}
          avatarHeight={optimizedAvatar.attributes.height as number}
          socialLinks={site.socialLinks}
          email={site.email}
        />
      </div>

      <div id="experience">
        <ExperienceTimeline client:visible experiences={experiences} />
      </div>

      <div id="skills">
        <SkillsGrid client:visible categories={skills} />
      </div>

      <div id="projects">
        <ProjectCards client:visible projects={projects} />
      </div>

      <SectionNav client:visible />
    </div>

    <!-- Photographer Mode sections -->
    <div id="photographer-content" style="display: none;">
      <MasonryGallery client:load images={galleryImages} />
    </div>
  </main>

  <Footer />
</Layout>

<style is:global>
  #toggle-wrapper {
    transition:
      transform 400ms cubic-bezier(0.22, 1, 0.36, 1),
      opacity 350ms ease,
      filter 300ms ease;
  }
  #toggle-wrapper.vapor-hidden {
    transform: translateY(-20px) scale(0.85);
    opacity: 0;
    filter: blur(8px);
    pointer-events: none;
  }
  #toggle-wrapper.lightbox-hidden,
  footer.lightbox-hidden {
    opacity: 0;
    pointer-events: none;
    transition: opacity 250ms ease;
  }
</style>

<script>
  import { lightboxOpen } from '@/stores/lightbox';

  const wrapper = document.getElementById('toggle-wrapper');
  const footer = document.querySelector('footer');
  let lastScrollY = window.scrollY;
  let ticking = false;
  let lightboxActive = false;

  lightboxOpen.subscribe((open) => {
    lightboxActive = open;
    if (open) {
      wrapper?.classList.add('lightbox-hidden');
      footer?.classList.add('lightbox-hidden');
    } else {
      wrapper?.classList.remove('lightbox-hidden');
      footer?.classList.remove('lightbox-hidden');
    }
  });

  window.addEventListener(
    'scroll',
    () => {
      if (ticking || lightboxActive) return;
      ticking = true;
      requestAnimationFrame(() => {
        const currentY = window.scrollY;
        if (currentY < 100 || currentY < lastScrollY) {
          wrapper?.classList.remove('vapor-hidden');
        } else if (currentY > lastScrollY) {
          wrapper?.classList.add('vapor-hidden');
        }
        lastScrollY = currentY;
        ticking = false;
      });
    },
    { passive: true },
  );
</script>
