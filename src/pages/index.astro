---
import { getImage } from 'astro:assets';
import Layout from '@/layouts/Layout.astro';
import Footer from '@/components/shared/Footer.astro';
import ModeToggle from '@/components/shared/ModeToggle.vue';
import Hero from '@/components/developer/Hero.vue';
import ExperienceTimeline from '@/components/developer/ExperienceTimeline.vue';
import SkillsGrid from '@/components/developer/SkillsGrid.vue';
import ProjectCards from '@/components/developer/ProjectCards.vue';
import SectionNav from '@/components/developer/SectionNav.vue';
import MasonryGallery from '@/components/photographer/MasonryGallery.vue';
import PhotoHero from '@/components/photographer/PhotoHero.vue';
import GearBar from '@/components/photographer/GearBar.vue';
import ModeTransitionController from '@/components/shared/ModeTransitionController.vue';
import {
  loadSiteConfig,
  loadExperience,
  loadProjects,
  loadSkills,
  loadPhotos,
  loadGear,
} from '@/utils/data';

import avatarImage from '@/assets/images/ryou.png';

const site = loadSiteConfig();
const experiences = loadExperience();
const projects = loadProjects();
const skills = loadSkills();
const photosData = loadPhotos();
const gear = loadGear();

// Process avatar image for Hero
let optimizedAvatar: Awaited<ReturnType<typeof getImage>>;
try {
  optimizedAvatar = await getImage({ src: avatarImage, width: 160 });
} catch (e) {
  console.error('[index] Failed to optimize avatar image, using raw source:', e);
  optimizedAvatar = { src: avatarImage.src, attributes: { width: 160, height: 160 } } as Awaited<
    ReturnType<typeof getImage>
  >;
}

// Gallery images served from Cloudflare R2
const R2_BASE = 'https://images.xuno8.com';

const galleryImages = photosData.map((photo) => ({
  src: `${R2_BASE}/${photo.src}`,
  thumbSrc: `${R2_BASE}/cdn-cgi/image/width=800,quality=80,format=auto,onerror=redirect/${photo.src}`,
  width: photo.width,
  height: photo.height,
  alt: photo.alt,
  caption: photo.caption,
  date: photo.date,
  location: photo.location,
  camera: photo.camera,
}));

// Fisher-Yates shuffle for random gallery order on each build
for (let i = galleryImages.length - 1; i > 0; i--) {
  const j = Math.floor(Math.random() * (i + 1));
  [galleryImages[i], galleryImages[j]] = [galleryImages[j], galleryImages[i]];
}
---

<Layout>
  <!-- Liquid Glass SVG filter (Chromium-only refraction enhancement) -->
  <svg style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true">
    <defs>
      <filter id="liquid-glass-filter" color-interpolation-filters="sRGB">
        <feTurbulence
          type="fractalNoise"
          baseFrequency="0.015"
          numOctaves="2"
          seed="3"
          result="noise"></feTurbulence>
        <feDisplacementMap
          in="SourceGraphic"
          in2="noise"
          scale="6"
          xChannelSelector="R"
          yChannelSelector="G"
          result="displaced"></feDisplacementMap>
        <feGaussianBlur in="displaced" stdDeviation="0.5" result="softened"></feGaussianBlur>
        <feComposite in="softened" in2="SourceGraphic" operator="in"></feComposite>
      </filter>
    </defs>
  </svg>

  <div id="toggle-wrapper" class="fixed top-4 right-4 z-50">
    <ModeToggle client:only="vue" />
  </div>

  <ModeTransitionController client:only="vue" />

  <main>
    <!-- Developer Mode sections -->
    <div id="developer-content">
      <div id="hero">
        <Hero
          client:load
          name={site.name}
          title={site.title}
          intro={site.intro}
          avatarSrc={optimizedAvatar.src}
          avatarWidth={optimizedAvatar.attributes.width as number}
          avatarHeight={optimizedAvatar.attributes.height as number}
          socialLinks={site.socialLinks}
          email={site.email}
        />
      </div>

      <div id="experience">
        <ExperienceTimeline client:visible experiences={experiences} />
      </div>

      <div id="skills">
        <SkillsGrid client:visible categories={skills} />
      </div>

      <div id="projects">
        <ProjectCards client:visible projects={projects} />
      </div>

      <SectionNav client:visible />
    </div>

    <!-- Photographer Mode sections -->
    <div id="photographer-content" style="display: none;">
      <PhotoHero client:load name={site.name} tagline={site.photographerTagline ?? ''} />
      <MasonryGallery client:load images={galleryImages} />
      <GearBar client:visible gear={gear} />
    </div>
  </main>

  <!-- Sync initial content visibility from URL param before Vue hydrates -->
  <script is:inline>
    (function () {
      if (window.__INITIAL_MODE__ === 'photographer') {
        document.getElementById('developer-content').style.display = 'none';
        document.getElementById('photographer-content').style.display = '';
      }
    })();
  </script>

  <Footer />
</Layout>

<style is:global>
  #toggle-wrapper {
    transition:
      transform 400ms cubic-bezier(0.22, 1, 0.36, 1),
      opacity 350ms ease,
      filter 300ms ease;
  }
  #toggle-wrapper.vapor-hidden {
    transform: translateY(-20px) scale(0.85);
    opacity: 0;
    filter: blur(8px);
    pointer-events: none;
  }
  #toggle-wrapper.lightbox-hidden,
  footer.lightbox-hidden {
    opacity: 0;
    pointer-events: none;
    transition: opacity 250ms ease;
  }
</style>

<script>
  import { lightboxOpen } from '@/stores/lightbox';

  const wrapper = document.getElementById('toggle-wrapper');
  const footer = document.querySelector('footer');
  let lastScrollY = window.scrollY;
  let ticking = false;
  let lightboxActive = false;

  lightboxOpen.subscribe((open) => {
    lightboxActive = open;
    if (open) {
      wrapper?.classList.add('lightbox-hidden');
      footer?.classList.add('lightbox-hidden');
    } else {
      wrapper?.classList.remove('lightbox-hidden');
      footer?.classList.remove('lightbox-hidden');
    }
  });

  window.addEventListener(
    'scroll',
    () => {
      if (ticking || lightboxActive) return;
      ticking = true;
      requestAnimationFrame(() => {
        const currentY = window.scrollY;
        if (currentY < 100 || currentY < lastScrollY) {
          wrapper?.classList.remove('vapor-hidden');
        } else if (currentY > lastScrollY) {
          wrapper?.classList.add('vapor-hidden');
        }
        lastScrollY = currentY;
        ticking = false;
      });
    },
    { passive: true },
  );
</script>
